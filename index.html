<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Animatee</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <style>
        body {
            margin: 0;
            font-family: "Comic Sans MS", sans-serif;
            user-select: none;
        }
        .main-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        #drop-target {
            width: 100%;
            height: 100%;
            max-width: 800px;
            max-height: 300px;
            background: #f9fffb;
            border: 1px dashed #363434;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            margin: 50px;
        }
        .drop-target__bar {
            position: absolute;
            background: #E6FFDE;
            width: 0;
            height: 100%;
            left: 0;
        }
        .drop-target__text {
            color: #363434;
            position: absolute;
            text-align: center;
        }
        .drop-target__text__small {
            margin-top: 20px;
            display: inline-block;
            opacity: 0.5;
        }
        #canvas-target {
            position: absolute;
            opacity: 0.1;
        }
    </style>
    <script src="gif.js"></script>
</head>
<body>
<div class="main-wrapper">
    <div id="drop-target">
        <div class="drop-target__bar"></div>
        <canvas id="canvas-target"></canvas>
        <div class="drop-target__text">
            <div>Drop or click to upload a static image here</div>
            <small class="drop-target__text__small">Please disable Ads/Popout blocker as it needs to pop out the gif.</small>
        </div>
    </div>
    <input type="file" id="file-target" style="display: none;" />
</div>
</body>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const MAX_HEIGHT = 100;
    const DROP_TARGET = "#drop-target";
    const CANVAS_TARGET = "#canvas-target";
    const FILE_TARGET = "#file-target";
    const FAKE_PROCESS = ".drop-target__bar";

    const processBar = document.querySelector(FAKE_PROCESS);
    const factors = [1, 0.99, 0.98, 0.96, 0.955, 0.955, 0.96, 0.97, 0.975, 0.98, 0.985, 0.99, 1, 1, 1, 1, 1, 1, 1];
    const factorLength = factors.length;

    let dropTarget = document.querySelector(DROP_TARGET);
    let fileTarget = document.querySelector(FILE_TARGET);

    dropTarget.addEventListener("dragover", (e) => {e.preventDefault();}, true);
    dropTarget.addEventListener("drop", (e) => {
      e.preventDefault();
      loadImage(e.dataTransfer.files[0]);
    }, true);
    dropTarget.addEventListener("dragenter", (e) => {
      console.log(e.target);
      if (e.target.id === DROP_TARGET.substr(1)) {
        e.target.style.backgroundColor = "bisque";
      }
    }, false);
    dropTarget.addEventListener("dragleave", (e) => {
      if (e.target.id === DROP_TARGET.substr(1)) {
        e.target.style.backgroundColor = "#f9fffb";
      }
    }, false);
    dropTarget.addEventListener("click", (e) => {
      fileTarget.click();
    }, false);

    fileTarget.addEventListener("change", (e) => {
      e.preventDefault();
      loadImage(e.target.files[0]);
    }, false);

    function loadImage(src){
      // Prevent any non-image file type from being read.
      if(!src.type.match(/image.*/)){
        console.log("The dropped file is not an image: ", src.type);
        return;
      }

      // Create our FileReader and run the results through the render function.
      let reader = new FileReader();
      reader.onload = function(e){
        render(e.target.result);
      };
      reader.readAsDataURL(src);
    }

    function render(src){
      let image = new Image();
      image.src = src;

      image.onload = function(){
        let canvas, ctx;
        [canvas, ctx] = initiateCanvas(CANVAS_TARGET, image);

        const gif = new GIF({
          workers: 2,
          quality: 10,
          background: '#fff',
          transparent: '#000',
          dither: true
        });

        let counter = 0;
        const i = setInterval(() => {
          const factor = factors[counter];
          clearCanvas(ctx, canvas);
          drawImage(ctx, image, factor);
          gif.addFrame(canvas, {
            copy: true,
            delay: 1
          });
          processBar.style.width = (counter / factorLength * 100) + "%";
          counter++;
          if (counter === factorLength) {
            clearInterval(i);
            gif.on('finished', function(blob) {
              processBar.style.width = "100%";
              window.open(URL.createObjectURL(blob));
            });
            gif.render();
          }
        }, 10);
      };
    }

    function clearCanvas(ctx, canvas) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    function drawImage(ctx, image, factor) {
      ctx.transform(1, 0, 0, factor, 0, 0);
      ctx.translate(0, image.height * (1 - factor) / factor);
      ctx.drawImage(image, 0, 0, image.width, image.height);
      ctx.setTransform(1, 0, 0, 1, 0, 0);
    }

    function initiateCanvas(CANVAS_TARGET, image) {
      let canvas = document.querySelector(CANVAS_TARGET);
      if(image.height > MAX_HEIGHT) {
        image.width *= MAX_HEIGHT / image.height;
        image.height = MAX_HEIGHT;
      }
      let ctx = canvas.getContext("2d");
      clearCanvas(ctx, canvas);
      canvas.width = image.width;
      canvas.height = image.height;

      return [canvas, ctx];
    }
  });



</script>
</html>
